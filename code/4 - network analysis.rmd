---
title: "4 - network analysis"
author: "Clint McKenna"
date: "9/15/2020"
output: html_document
---


## data prep

```{r}
# load packages
library(tidyverse)

# read in data from csv
tennis <- read.csv('../data/raw/wta_matches_2015.csv')
collegefb <- read.csv('../data/raw/CFBeattendance.csv')
netflix <- read.csv('../data/raw/netflix_titles.csv')
books <- read.csv('../data/raw/books.csv')


# custom functions
select <- dplyr::select
# ggplot2 alpha (sometimes gets a conflict depending on other packages)
alpha <- scales::alpha

# color palette
UMcolors <- c('#ffcb05', '#00274c', '#407EC9', '#9A3324', '#702082', '#D86018', '#00B2A9')

```


## creating edgelist

This will be somewhat related to the network stuff we did during the school year. For starters, we will look at the college football data. Normally we would want to have a complete dataset of all games, but this will be practice.

As a reminder, one way of organizing relational data is an edgelist. Typically if we have a directed edgelist, it involves a sender and receiver. So imagine an email network, where one person sends an email to a receiver. Both are connected to each other, but the direction of the arrow has significance. 

The football and tennis data are pretty close already since there is already a Team and Opponent column. We will organize it to have a "sender" column of a losing team, who has an arrow to the "receiver" column, the winning team. This is following some publications I found in tennis (https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0017249) and boxing (https://academic.oup.com/comnet/article-abstract/8/1/cnaa009/5770924).

```{r}
# select columns
edgelist <- collegefb %>% 
  select(Team, Opponent, Result)

# for some reason, some of the teams have an asterisk on them. I couldn't figure out what this meant, but we will just remove them
# for special characters, if you are doing regex, you can wrap in []
edgelist <- edgelist %>%
  mutate(Team = str_replace(Team, '[*]', '')) %>%
  mutate(Opponent = str_replace(Opponent, '[*]', ''))


# also, some team team names have No. 17 LSU, or something like that
# we will do the same thing and just replace this with empty string
edgelist <- edgelist %>%
  mutate(Team = str_replace(Team, 'No[.]\\s', '')) %>%
  mutate(Opponent = str_replace(Opponent, 'No[.]\\s', '')) %>%
  mutate(Team = str_replace(Team, '[0-9]+', '')) %>%
  mutate(Opponent = str_replace(Opponent, '[0-9]+', ''))
  
# I initially overwrite things like "North Texas", so redid the regex
# 'No[.]\\s' contains 'No' followed by '.' followed by a space (\s)
# a confusing thing with any slash character like \s is that you need to "escape" it by adding another \ in front of it


# now, check if team won or not
# sender = loser
# receiver = winner
# I'll just use more stringr functions to make new columns
edgelist <- edgelist %>%
  mutate(sender = case_when(
    str_starts(Result, 'L') ~ Team,
    str_starts(Result, 'W') ~ Opponent,
    TRUE ~ NA_character_)) %>%
  mutate(receiver = case_when(
    str_starts(Result, 'L') ~ Opponent,
    str_starts(Result, 'W') ~ Team,
    TRUE ~ NA_character_))


# keep only receiver and sender cols, and drop NA values
edgelist <- edgelist %>%
  select(sender, receiver) %>%
  na.omit()

# preview edgelist
head(edgelist)
```

Looks good enough! There are some weird text inconsistencies, like "Hawai<U+BB>i" vs. "Hawaii." Likely due to error in scraping the original dataset. I'll ignore these for now, since we would probs need to go through them one by one. 


## create network

We will use the igraph package to create a network object.
```{r}
# load library
library(igraph)

# create edgelist from dataframe..."edgelist"
net <- graph_from_data_frame(edgelist, directed = TRUE)

```

# with this object, you can access values related to edges and vertices with E() and V().

```{r}
# check edges
E(net)

# check vertices
V(net)
```

Now we will try plotting...

```{r}
# plot
plot(net)

```


Kind of a mess, so we will scale some of the values in the network. Let's set some of the vertice values.

For size, I'll just take the natural log of the degree. As you might remember, degree is the number of ties/edges that any given vertex/node has. So if Michigan played 10 different teams in this dataset, they would have a degree of 10.

```{r}
# we can assign values to vertex attributes similar to dataframes
# size
V(net)$size <- log(degree(net))

# label
V(net)$label <- NA

# colors
V(net)$color <- UMcolors[2]

# plot
plot(net)
```

Forgot the arrow sizes, which are absurd for the size of some of the nodes.
```{r}
# edge size is in E() attributes
E(net)$arrow.size <- .05

# can also color the edges
E(net)$color <- UMcolors[1]

# plot
plot(net)

```

Just visually, you can tell that there are a ton of teams that had 1 game in the dataset, losing to some other more centrally placed team in the network.


```{r}

V(net)$size <- eigen_centrality(net)

plot(net)
```




















## PRACTICE











